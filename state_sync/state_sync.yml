## STATE SYNC
# Syncs two backup container pvcs together to be used as the primary source of state
# synconrizations between two different openshift cluster rh sso db deployments
# NOMENCLATURE
# TARGET CLUSTER: the target cluster is the receiver of any state
# SOURCE CLUSTER: where the state is being sync'd from
---
  - hosts: localhost
    gather_facts: no
    vars_prompt:
    # can skip these by running playbook with --extra-vars
      - name: "has_cluster_contexts"
        prompt: "have you logged into {{ migrator_vars.cluster_a.server_url }} and {{ migrator_vars.cluster_b.server_url }}?"
        private: no
    vars_files:
      - group_vars/all/vars.yml
    tasks:
      - when: not has_cluster_contexts|bool
        debug:
          msg: "Must be logged into both clusters as well as have had run a backup in cluster A"
      - failed_when: not has_cluster_contexts|bool
        shell: echo "Starting!"
      - name: Pre requisites
        include_tasks: ./tasks/prereqs.yml

      - name: Login to Cluster A
        shell: oc config use-context {{ migrator_vars.cluster_a.context }}
      - name: Scaling Cluster A Services to 0
        include_tasks: ./tasks/scale_down_services.yml
        vars:
          TARGET_NAMESPACE: "{{ migrator_vars.cluster_a.namespace }}"
          SSO_DC_NAME: "{{ migrator_vars.cluster_a.sso_deployment_config }}"
          SSO_BACKUP_NAME: "{{ migrator_vars.cluster_a.backup_deployment_config }}"
          SSO_HPA_NAME: "{{ migrator_vars.cluster_a.sso_hpa_name }}"

      - name: Login to Cluster B
        shell: oc config use-context {{ migrator_vars.cluster_b.context }}
      - name: Scaling Cluster B Services to 0
        include_tasks: ./tasks/scale_down_services.yml
        vars:
          TARGET_NAMESPACE: "{{ migrator_vars.cluster_b.namespace }}"
          SSO_DC_NAME: "{{ migrator_vars.cluster_b.sso_deployment_config }}"
          SSO_BACKUP_NAME: "{{ migrator_vars.cluster_b.backup_deployment_config }}"
          SSO_HPA_NAME: "{{ migrator_vars.cluster_b.sso_hpa_name }}"
      - debug:
          msg: Beginning Migration Process
      
      # - name: Deploying Source Migrator to Cluster A
      #   include_tasks: ./tasks/deploy_cluster_a_migrator.yml
      - name: Deploying Source Migrator to Cluster B
        include_tasks: ./tasks/deploy_cluster_b_migrator.yml

      # - name: Scaling SSO to 0 Pods 
      #   vars:
      #     SSO_DC_NAME: "{{ SOURCE_SSO_DC_NAME }}"
      #   include_tasks: ../ops/tasks/scale_down_sso.yml
      #   when: backup_run | bool
      
      # - debug: 
      #     msg: "Unable to continue until you have completed a backup"
      #   when: not backup_run | bool